# GitLab CI/CD Pipeline for Music Store Application

stages:
  - build
  - test
  - quality

variables:
  # Maven configuration
  MAVEN_OPTS: "-Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository"
  MAVEN_CLI_OPTS: "--batch-mode --errors --fail-at-end --show-version"
  
  # Test database configuration
  POSTGRES_DB: music_store_test
  POSTGRES_USER: test
  POSTGRES_PASSWORD: test
  SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/music_store_test
  SPRING_DATASOURCE_USERNAME: test
  SPRING_DATASOURCE_PASSWORD: test
  SPRING_JPA_HIBERNATE_DDL_AUTO: create-drop

# Cache Maven dependencies for faster builds
cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - .m2/repository

backend-build:
  stage: build
  image: maven:3.9-eclipse-temurin-17
  script:
    - echo "Building backend application..."
    - mvn $MAVEN_CLI_OPTS clean compile
  artifacts:
    paths:
      - target/
    expire_in: 1 hour

backend-test:
  stage: test
  image: maven:3.9-eclipse-temurin-17
  services:
    - name: postgres:15-alpine
      alias: postgres
  variables:
    POSTGRES_HOST_AUTH_METHOD: trust
  script:
    - echo "Running backend tests..."
    - mvn $MAVEN_CLI_OPTS test
    - echo "Generating coverage report..."
    - mvn jacoco:report
  coverage: '/Total.*?([0-9]{1,3})%/'
  artifacts:
    when: always
    reports:
      junit:
        - target/surefire-reports/TEST-*.xml
      coverage_report:
        coverage_format: cobertura
        path: target/site/jacoco/jacoco.xml
    paths:
      - target/surefire-reports/
      - target/site/jacoco/
    expire_in: 7 days

backend-checkstyle:
  stage: quality
  image: maven:3.9-eclipse-temurin-17
  script:
    - echo "Running Checkstyle analysis..."
    - mvn $MAVEN_CLI_OPTS checkstyle:check
  artifacts:
    when: on_failure
    paths:
      - target/checkstyle-result.xml
    expire_in: 7 days
  allow_failure: true

validate-coverage:
  stage: quality
  image: alpine:latest
  script:
    - echo "======================================"
    - echo "Test Coverage Report"
    - echo "======================================"
    - echo "Coverage tracking enabled for monitoring"
    - echo "No minimum threshold enforced"
    - echo "======================================"
  needs:
    - backend-test

workflow:
  rules:
    # Run pipeline for merge requests
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    # Run pipeline for commits to main branch
    - if: '$CI_COMMIT_BRANCH == "main"'
    # Run pipeline for commits to develop branch
    - if: '$CI_COMMIT_BRANCH == "develop"'
    # Run pipeline for any branch push
    - if: '$CI_COMMIT_BRANCH'

